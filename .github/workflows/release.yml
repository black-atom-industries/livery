name: Release
on:
    push:
        branches: [main]

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  config-file: .github/release-please-config.json
                  manifest-file: .github/.release-please-manifest.json

            # When release-please creates/updates a PR, regenerate Cargo.lock
            # so it stays in sync with the version bump in Cargo.toml
            - uses: actions/checkout@v4
              if: steps.release.outputs.pr
              with:
                  ref: ${{ fromJSON(steps.release.outputs.pr).headBranchName }}

            - name: Update Cargo.lock
              if: steps.release.outputs.pr
              working-directory: src-tauri
              run: cargo update --workspace

            - name: Commit Cargo.lock
              if: steps.release.outputs.pr
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add src-tauri/Cargo.lock
                  git diff --cached --quiet || git commit -m "chore: sync Cargo.lock with version bump"
                  git push
